services:
  traefik:
    image: traefik:v3.0
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      # Enable plugins from Traefik Plugin Catalog
      - "--experimental.plugins.payload-router.moduleName=github.com/innolabsdev/traefik-payload-router"
      - "--experimental.plugins.payload-router.version=v1.0.0"
    ports:
      - "8080:80"
      - "8081:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  # Main site handler - catches all paths but plugin only processes /webhook
  main-site:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    labels:
      - "traefik.enable=true"
      
      # Single router for all paths with plugin middleware
      - "traefik.http.routers.main.rule=PathPrefix(`/`)"
      - "traefik.http.routers.main.entrypoints=web"
      - "traefik.http.routers.main.middlewares=payload-router"
      
      # Production plugin configuration  
      - "traefik.http.middlewares.payload-router.plugin.payload-router.fieldName=endpoint_id"
      - "traefik.http.middlewares.payload-router.plugin.payload-router.redirectMappings.customer1=http://backend-customer1:80/webhook"
      - "traefik.http.middlewares.payload-router.plugin.payload-router.redirectMappings.customer2=http://backend-customer2:80/webhook"
      - "traefik.http.middlewares.payload-router.plugin.payload-router.redirectMappings.customer3=http://backend-customer3:80/webhook"
      - "traefik.http.middlewares.payload-router.plugin.payload-router.defaultRedirect=http://default-webhook:80/webhook"
      - "traefik.http.middlewares.payload-router.plugin.payload-router.webhookPath=/webhook"
      
      - "traefik.http.services.main-site.loadbalancer.server.port=80"

  # Customer backend services
  backend-customer1:
    image: ealen/echo-server:latest
    environment:
      - ECHO_HEADER_X-Customer=Customer-1
      - ECHO_HEADER_X-Environment=Production
    labels:
      - "traefik.enable=false"

  backend-customer2:
    image: ealen/echo-server:latest
    environment:
      - ECHO_HEADER_X-Customer=Customer-2
      - ECHO_HEADER_X-Environment=Production
    labels:
      - "traefik.enable=false"

  backend-customer3:
    image: ealen/echo-server:latest
    environment:
      - ECHO_HEADER_X-Customer=Customer-3
      - ECHO_HEADER_X-Environment=Production
    labels:
      - "traefik.enable=false"

  default-webhook:
    image: ealen/echo-server:latest
    environment:
      - ECHO_HEADER_X-Customer=Default
      - ECHO_HEADER_X-Environment=Production
    labels:
      - "traefik.enable=false"